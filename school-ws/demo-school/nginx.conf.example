# =====================================================================
# Nginx 配置示例 - 学校公告站点部署
# =====================================================================
# 
# 用途：在 Nginx 服务器上部署静态公告站点
# 使用：将此文件内容复制到 /etc/nginx/sites-available/school-announcements.conf
#      然后执行：sudo ln -s ... sites-enabled/
#              sudo systemctl restart nginx
# 
# =====================================================================

# HTTP 重定向到 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name announcements.example-school.edu.cn;
    
    # 用于 Let's Encrypt 验证
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # 其他请求都重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name announcements.example-school.edu.cn;
    
    # =============== SSL 证书配置 ===============
    ssl_certificate /etc/letsencrypt/live/announcements.example-school.edu.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/announcements.example-school.edu.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # =============== 日志配置 ===============
    access_log /var/log/nginx/school-announcements-access.log;
    error_log /var/log/nginx/school-announcements-error.log;
    
    # =============== 性能优化 ===============
    client_max_body_size 10M;  # 最大上传文件 10MB
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    gzip_min_length 1000;
    
    # =============== 缓存策略 ===============
    # 静态资源 30 天缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # HTML 文件不缓存，或 1 小时缓存
    location ~* \.html$ {
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # =============== 安全头 ===============
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # =============== HSTS ===============
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # =============== 根目录配置 ===============
    root /var/www/school-announcements;
    index index.html index.htm;
    
    # =============== 路由配置 ===============
    # 如果文件不存在，返回 index.html（SPA 路由）
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # =============== API 代理（如需后端） ===============
    # 将 /api 请求代理到后端服务器
    # location /api/ {
    #     proxy_pass http://api.example-school.edu.cn;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # =============== 错误页面 ===============
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}

# =====================================================================
# 生成 SSL 证书命令（使用 Let's Encrypt）
# =====================================================================
# 
# sudo apt-get install certbot python3-certbot-nginx
# 
# sudo certbot certonly --webroot -w /var/www/certbot \
#     -d announcements.example-school.edu.cn \
#     --email admin@example-school.edu.cn \
#     --agree-tos \
#     -n
# 
# 自动续期：
# sudo certbot renew --quiet --no-eff-email
# 
# =====================================================================

# =====================================================================
# Nginx 常用命令
# =====================================================================
# 
# 检查配置语法
# nginx -t
# sudo nginx -t
# 
# 重新加载配置
# sudo systemctl reload nginx
# 
# 重启 Nginx
# sudo systemctl restart nginx
# 
# 查看状态
# sudo systemctl status nginx
# 
# 查看日志
# tail -f /var/log/nginx/school-announcements-access.log
# tail -f /var/log/nginx/school-announcements-error.log
# 
# =====================================================================
